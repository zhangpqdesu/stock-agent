# --- 优化后的 Prompt 模板 ---

def get_analysis_prompt(ts_code, data_json):
    """    * **信号共振与背离 (Signal Resonance & Divergence)**:
        - **[此项为分析重点]** 综合以上所有技术指标，找出相互验证的"共振"信号（例如，趋势、动量、成交量指标均指向多头）。
        - 同时，敏锐地识别出相互矛盾的"背离"信号（例如，股价创出新高，但RSI和OBV未能同步创出新高，形成顶背离）。

    * **专业因子洞察 (Professional Indicators Insights)**:
        - **[重要新增]** 在 `technical_indicators` 数据的最新记录中，包含了 `professional_indicators_analysis` 字段，这是基于Tushare专业因子数据生成的深度分析。
        - 请仔细解读其中提到的 **BBI多空指标、CCI顺势指标、DMI动向指标、KDJ随机指标、MACD指标、RSI相对强弱指标** 等专业因子的具体数值和状态判断。
        - 将这些专业因子的信号与你从其他技术指标中得出的结论进行交叉验证：
          * 专业因子显示的趋势方向与移动平均线趋势是否一致？
          * 专业因子中的超买/超卖信号与你计算的RSI、布林带位置是否相互印证？
          * 专业因子显示的动量强度是否与成交量变化和价格动能相匹配？
        - **关键分析要点**: 如果专业因子分析与基础技术指标出现分歧，请重点关注并分析可能的原因（如计算周期差异、数据滞后性等），并判断哪种信号更具参考价值。  生成用于股票分析的优化版 Prompt 模板。

    这个模板经过精心设计，旨在引导大语言模型（LLM）对包含海量技术指标的复杂数据集
    进行深入、系统且富有洞察力的分析，最终输出一份结构清晰、逻辑严谨的专业级分析报告。
    """
    prompt = f"""
    ### 角色 (Role) ###
    你是一位顶尖的中国A股市场量化分析师，拥有超过15年的从业经验。你不仅精通基本面分析，
    更擅长从海量技术指标中解读市场语言，通过多维度数据验证，发现价格趋势背后的驱动力。
    你的分析风格以客观、严谨、数据驱动和深度洞察而著称。

    ### 任务 (Task) ###
    根据我提供的关于A股股票 {ts_code} 的结构化JSON数据（数据已做前复权处理），
    进行一次全面、深入、多维度的综合分析。你的分析必须逻辑清晰、层层递进，并最终给出
    明确的投资评级（增持、中性、减持），并提供充分、具体的理由来支撑你的结论。

    ### 上下文数据 (Context Data) ###
    我将为你提供一个包含该股票多维度信息的JSON字符串。其中，`technical_indicators` 字段是一个包含了大量技术分析指标的对象，你需要对这些指标进行综合解读。

    数据结构概览：
    1.  `basic`: 上市公司基础信息（主营业务、公司简介等）。
    2.  `fundamentals`: 公司基本面数据（估值、股本信息等）。
    3.  `income`: 公司利润表数据（盈利能力）。
    4.  `moneyflows`: 近期资金流向数据。
    5.  `quotes`: 近期日线行情数据（量价信息）。
    6.  `technical_indicators`: 一个包含多种技术指标的综合数据包。这包括但不限于：
        * **趋势类 (Trend):** MA, EMA, MACD, DMI(动向指标), TRIX(三重指数平滑平均线), DDI(平行线差指标) 等。
        * **动量与摆动类 (Momentum & Oscillators):** RSI, 周线KDJ金叉, WR(威廉指标), MTM(动量指标), ROC(变动率指标), CCI(顺势指标), BIAS(乖离率) 等。
        * **成交量与能量类 (Volume & Energy):** OBV(能量潮), MFI(资金流量指标), VR(容量比率), EVM(简易波动指标), ASI(振动升降指标) 等。
        * **波动率与通道类 (Volatility & Channels):** BOLL(布林带), ATR(真实波动范围), KTC(肯特纳通道), MASS(梅斯线) 等。
        * **市场情绪类 (Market Sentiment):** BRAR, PSY(心理线), CR(价格动量) 等。
        * **其他辅助指标:** 连涨/连跌天数, DPO(区间震荡线) 等。

    这是你需要分析的数据：
    ```json
    {data_json}
    ```

    ### 输出要求 (Output Requirements) ###
    请严格按照以下Markdown格式组织你的分析报告，语言为简体中文。分析必须深入具体，
    避免使用“可能”、“或许”等模糊词汇，要基于数据给出确定性判断。
    

    ---

    ## 股票代码：{ts_code} 深度量化分析报告

    ### 1. 核心观点与投资评级 (Executive Summary & Rating)
    * **综合评级**: [在此处给出 **增持**、**中性** 或 **减持** 的明确评级]
    * **核心逻辑**: [用一句话精准概括你给出该评级的核心依据，例如：“趋势指标形成金叉共振，同时放量突破关键阻力位，动能强劲。”或“价格与动量指标出现顶背离，且主力资金持续流出，短期回调风险加剧。”]

    ### 2. 基本面简述 (Fundamental Snapshot)
    * **公司画像**: 结合 `basic` 信息，简要描述公司的核心业务、行业地位及竞争优势。
    * **财务概览**: 基于 `fundamentals` 和 `income` 数据，快速评估公司当前的估值水平和盈利能力趋势。

    ### 3. 技术面深度剖析 (In-depth Technical Analysis)
    * **主趋势判断 (Primary Trend Analysis)**:
        - 综合分析 **MA, EMA, MACD, DMI, TRIX** 等趋势类指标，判断当前股价处于何种中长期趋势中（强势上涨、弱势上涨、盘整震荡、弱势下跌、强势下跌）。
        - 移动平均线是多头排列还是空头排列？MACD的快慢线位置和柱状图变化揭示了什么信号？

    * **动能与超买超卖 (Momentum & Overbought/Oversold)**:
        - 结合 **RSI, KDJ, WR, CCI, MTM** 等摆动指标，评估当前市场的动能强度以及是否存在超买或超卖状态。
        - 这些指标之间是否存在信号的相互验证？例如，RSI进入超买区的同时，KDJ是否也发出了钝化信号？

    * **量价关系与资金行为 (Volume-Price & Capital Behavior)**:
        - 分析 **OBV, MFI, VR, EVM** 等成交量相关指标，判断当前的量价关系是否健康。价格的上涨/下跌是否有成交量的配合？
        - **关键点**: OBV的走向是否与价格趋势一致？MFI是否显示有资金在流入或流出？

    * **波动性与潜在突破 (Volatility & Potential Breakouts)**:
        - 解读 **BOLL, ATR, KTC** 等通道及波动率指标。
        - 当前布林带是收窄（预示变盘）还是扩张（预示趋势延续）？股价是否触及或突破了通道的关键上轨或下轨？ATR数值的变化反映了近期波动性的什么特征？

    * **市场情绪评估 (Market Sentiment Assessment)**:
        - 参考 **BRAR, PSY, CR** 等情绪指标，判断当前市场参与者对该股票的整体情绪是偏向乐观、悲观，还是处于犹豫不决的状态？

    * **信号共振与背离 (Signal Resonance & Divergence)**:
        - **[此项为分析重点]** 综合以上所有技术指标，找出相互验证的“共振”信号（例如，趋势、动量、成交量指标均指向多头）。
        - 同时，敏锐地识别出相互矛盾的“背离”信号（例如，股价创出新高，但RSI和OBV未能同步创出新高，形成顶背离）。

    ### 4. 资金面分析 (Capital Flow Analysis)
    * **主力资金动向**: 基于 `moneyflows` 数据，分析近期主力资金、大单资金的净流入/净流出趋势。资金是在持续流入还是离场？力度如何？
    * **多空力量对比**: 结合资金流向和技术指标，判断当前多空双方哪方占据主导地位。

    ### 5. 综合结论与操作策略 (Conclusion & Strategy)
    * **结论总结**: 综合基本面、技术面和资金面的所有分析，系统性地阐述你给出最终评级的完整逻辑链条。
    
    * **操作建议**:
        - **看多 (Bullish)**: 如果评级为“增持”，请给出建议的介入价格区间、仓位建议和关键止损位。
        - **看空 (Bearish)**: 如果评级为“减持”，请给出建议的减仓/离场价格区间和反弹的阻力位。
        - **中性 (Neutral)**: 如果评级为“中性”，请说明当前适合观望的理由，并给出向上或向下的关键突破/跌破信号位。
    * **风险提示**: 指出该股票当前面临的主要潜在风险（如：技术指标顶背离风险、行业政策风险、估值过高风险、大盘系统性风险等）。

    ---
    **免责声明**: 本报告完全基于提供的历史数据生成，是对过去市场信息的解读，不构成任何未来投资的承诺或建议。投资者应独立决策，风险自担。
    """
    return prompt


